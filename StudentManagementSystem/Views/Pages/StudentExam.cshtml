<div class="container-fluid text-center">
    <section class="content">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card card-primary shadow-sm">
                    <div class="card-header text-white bg-primary">
                        <h3 class="card-title">Add Exam Marks to Student</h3>
                    </div>
                    <form>
                        <input type="hidden" class="form-control" id="id" value="0" />
                        <div class="card-body">
                            <div class="form-group">
                                <label for="examDropdown">Select Exam</label>
                                <select class="form-control" id="examDropdown">
                                    <!-- Options will be dynamically loaded here -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="studentDropdown">Select Student</label>
                                <select class="form-control" id="studentDropdown">
                                    <!-- Options will be dynamically loaded here -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="Marks">Enter Marks</label>
                                <input type="number" class="form-control" id="Marks" placeholder="Enter Marks" autocomplete="off" step="1" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                            </div>

                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input" id="isActive" checked="">
                                <label class="form-check-label" for="isActive">Active</label>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="button" id="savebtn" onclick="saveData()" class="btn btn-primary me-2">Save</button>
                            <button type="button" id="clearbtn" onclick="clearForm()" class="btn btn-danger">Clear</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="row mt-4 justify-content-center">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="card-title">Exam Marks for Students</h6>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-striped table-bordered table-hover" id="marksTable">
                            <thead>
                                <tr>
                                    <th hidden>ExamStudentId</th>
                                    <th>Exam Name</th>
                                    <th hidden>ExamId</th>
                                    <th hidden>StudentId</th>
                                    <th>Marks</th>
                                    <th>Active</th>
                                    <th>Edit</th>
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyid"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include DataTables JS -->
<script src="https://cdn.datatables.net/2.1.5/js/dataTables.min.js"></script>
<!-- Include DataTables CSS for styling -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.1.5/css/dataTables.dataTables.min.css">
<!-- Sweet Alert -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<script>
    function loadExams() {
        $.ajax({
            url: '/Exam/getall',
            type: 'GET',
            success: function (response) {
                var dropdown = $('#examDropdown');
                dropdown.empty();
                dropdown.append('<option value="" disabled selected>Select an Exam</option>');
                response.forEach(function (exam) {
                    dropdown.append($('<option></option>').attr('value', exam.id).text(exam.examName));
                });
            },
            error: function (err) {
                console.error('Error loading exams:', err);
            }
        });
    }

    function loadStudents() {
        $.ajax({
            url: '/student/getall',
            type: 'GET',
            success: function (response) {
                var dropdown = $('#studentDropdown');
                dropdown.empty();
                dropdown.append('<option value="" disabled selected>Select a Student</option>');
                response.forEach(function (student) {
                    dropdown.append($('<option></option>').attr('value', student.id).text(student.fullName));
                });
            },
            error: function (err) {
                console.error('Error loading students:', err);
            }
        });
    }

    function loadExamMarks() {
        $.ajax({
            url: '/StudentExam/getall',
            type: 'GET',
            success: function (response) {
                var tbody = $('#tbodyid');
                tbody.empty(); // Clear the table body

                if (Array.isArray(response)) {
                    response.forEach(function (examMark) {
                        var row = `<tr>
                                        <td hidden>${examMark.id}</td>
                                        <td>${examMark.exam.examName}</td>
                                        <td hidden>${examMark.exam.id}</td>
                                        <td hidden>${examMark.student.id}</td>
                                        <td>${examMark.mark}</td>
                                        <td>${examMark.isactive ? 'Yes' : 'No'}</td>
                                         <td><button class="btn btn-danger" onclick="getExam(${examMark.id})">Edit</button></td>
                                        <td><button class="btn btn-danger" onclick="deleteExamMark(${examMark.id})">Delete</button></td>
                                    </tr>`;
                        tbody.append(row);
                    });
                } else {
                    console.error('Expected an array but got:', response);
                }
            },
            error: function (err) {
                console.error('Error loading marks table:', err);
            }
        });
    }
    function getExam(courseId) {
        console.log('courseId', courseId)
        $.ajax({
            url: '/StudentExam/get/' + courseId,
            type: 'GET',
            success: function (response) {
                // Populate form fields with the response data
                $('#id').val(response.id);  // Assuming the ID is stored here
                $('#examDropdown').val(response.exam.id);  // Set the exam dropdown value
                $('#studentDropdown').val(response.student.id);  // Set the student dropdown value
                $('#Marks').val(response.mark);  // Set the marks field
                $('#isActive').prop('checked', response.isactive);  // Set active checkbox
            },
            error: function (err) {
                console.error('Error fetching exam data:', err);
            }
        });
    }

    function deleteExamMark(markId) {
        $.ajax({
            url: '/StudentExam/delete/' + markId,
            type: 'DELETE',
            success: function (response) {
                swal("Success", "Exam mark deleted successfully!", "success");
                loadExamMarks();
            },
            error: function (err) {
                console.error('Error deleting exam mark:', err);
            }
        });
    }

    function saveData() {
        var examId = $('#examDropdown').val();
        var studentId = $('#studentDropdown').val();
        var marks = $('#Marks').val();
        var isActive = $('#isActive').is(':checked');
        var id = $('#id').val();
        var data = {
            id :id,
            examid: examId,
            studentid: studentId,
            mark: marks,
            isactive: isActive
        };
        // Validate that exam, student, and marks are selected or entered
        if (!examId) {
            swal("Error", "Please select an exam.", "error");
            return;
        }

        if (!studentId) {
            swal("Error", "Please select a student.", "error");
            return;
        }

        if (!marks || marks <= 0) {
            swal("Error", "Please enter a valid mark.", "error");
            return;
        }

        $.ajax({
            url: '/StudentExam/create',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                swal("Success", "Exam mark saved successfully!", "success");
                loadExamMarks();
            },
            error: function (err) {
                console.error('Error saving exam mark:', err);
                alert('Error saving data. Please try again.');
            }
        });
    }

    function clearForm() {
        $('#examDropdown').val('');
        $('#studentDropdown').val('');
        $('#Marks').val('');
        $('#isActive').prop('checked', true);
        $('#marksTable').DataTable().clear().draw();
    }

    $(document).ready(function () {
        $.noConflict();
        $('#marksTable').DataTable({
            paging: false,
            searching: false,
            ordering: true,
            info: false
        });

        loadExams();
        loadStudents();
        loadExamMarks();
    });
</script>
